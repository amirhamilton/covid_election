---
title: "Effect of Covid 19 on Voting Patterns in the 2020 US Presidential Election"
author: "Amir Hamilton"
date: "11/19/2020"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(echo = FALSE, eval = TRUE)
library(tidyverse)
library("readxl")
library(rvest)
library(pdftools)
library(urbnmapr)
library(urbnthemes)
library(ggpubr)

devtools::install_github("UrbanInstitute/urbnmapr")

owid <- read.csv("https://raw.githubusercontent.com/owid/covid-19-data/master/public/data/owid-covid-data.csv") %>%
  filter(iso_code == "USA")


```

## Introduction

The main event that has characterized 2020 in the US and the world has been the Covid-19 Pandemic. In the US, there have been three main waves: Spring (March and April), Summer (July), and Winter (October - Present). Life for people in the US has been changed drastically, but the goal of this project is to see whether Covid has had any discernible effects on the 2020 presidential election. To begin, below is show a bar plot of new covid cases per day in the winter wave, which is currently ongoing. Approximately one month of data preceding election day is shown, as are the roughly one and a half months that have passed between then and now (December 14, 2020). Data has been read in from Our World in Data's (OWID) daily updated dataset. 


```{r total}
usa_owid <- owid %>%
  slice(255:325) ## make this more generalized
ggplot(usa_owid, aes(x = as.Date(date), y = new_cases)) +
  geom_col(fill = "#4b52ba") +
  labs(x = "Date", 
       y = "New Cases", 
       title = "Total New Cases in the US by Date From October 1 to December 11")
```
\newpage

# Reproduction Number (*R*)

*R*, the reproduction number, is a measure of the infectious potential of a disease. If *R* equals 1, then the number of cases will remain constant. If *R* is less than 1, then the number of cases are decreasing, and thus if *R* is greater than 1 the number of cases are increasing. Determining *R* is valuable for public health officials and lawmakers because it tells you what proportion of new infections you need to prevent in order to go from increasing cases to constant or decreasing cases.

At a particular time in the pandemic, *Rt* is written to signify the reproduction number at time *t*. 

There are several ways to calculate *R*, but I'm just using the data from OWID. The formula for *R* is considered to be different by different epidemiological schools, and can contain numbers such as:

  *T* -- the generation time-- which is the time between infection events in an infector-infectee pair of individuals; 
  
  *s* -- the serial interval -- which is the average time between symptoms of infection in the transmitter to when the person they infect develops symptoms; 
  
  *r* -- the epidemic growth rate -- which is the rate at which new cases are occurring; 
  
  *dt* -- doubling time -- the amount of time which leads to a doubling of cases; 
  
as well as the number of susceptible individuals, proportion of asymptomatic individuals, incubation time, disparate effects by age, duration from symptom onset to hospitalization or death, and the infectiousness of asymptomatic individuals. I'm leaving this calculation up to the experts, especially due to the fact that information changes frequently about these values.

Below is shown a box plot of *R* from the beginning of October to December 4, the latest day for which OWID has calculated *R*. A horizontal line of *R* = 1 shows that during the time period covered in this study, the severity of the pandemic has been increasing every day.

```{r reproduction.number, echo=FALSE, warning=FALSE}
ggplot(usa_owid, aes(x = as.Date(date), y = reproduction_rate)) +
  geom_col(fill = "#a55151") +
  labs(x = "Date", y = "R", title = "US Reproduction Number (R) Over Time") +
  geom_hline(yintercept = 1)
```
\newpage

## Presidential Election

To conduct my analysis, I had to get the data for election results. In order to achieve a sufficient level of granularity I gathered data on the county level. I could not find a dataset with all the election results for president by county, unfortunately, so I manually scraped the data from Politico and NBCNews. Another advantage of this method is that the data would be in the same format, since each state released their elections data in different formats. 

Here, I read in the data from the various excel spreadsheets I created (minus Alaska and DC). Alaska was excluded because election data was unavailable on a county level and DC was excluded because there is no county there. I then merged the state/county level data to create a national dataframe of election results, which I would be able to work with. 

The dataset is too large to show here in its entirety, but I've included a preview below:
```{r, message=FALSE}
alabama_president <- read_excel("data/state_election_results/alabama_president.xlsx") %>%
  mutate(state = "Alabama") %>%
  mutate(dispID = paste(county, state, sep = ", "))
arizona_president <- read_excel("data/state_election_results/arizona_president.xlsx") %>%
  mutate(state = "Arizona") %>%
  mutate(dispID = paste(county, state, sep = ", "))
arkansas_president <- read_excel("data/state_election_results/arkansas_president.xlsx") %>%
  mutate(state = "Arkansas") %>%
  mutate(dispID = paste(county, state, sep = ", "))
california_president <- read_excel("data/state_election_results/california_president.xlsx") %>%
  mutate(state = "California") %>%
  mutate(dispID = paste(county, state, sep = ", "))
colorado_president <- read_excel("data/state_election_results/colorado_president.xlsx") %>%
  mutate(state = "Colorado") %>%
  mutate(dispID = paste(county, state, sep = ", "))
connecticut_president <- read_excel("data/state_election_results/connecticut_president.xlsx") %>%
  mutate(state = "Alabama") %>%
  mutate(dispID = paste(county, state, sep = ", "))
dc_president <- read_excel("data/state_election_results/dc_president.xlsx") %>%
  mutate(state = "DC")
delaware_president <- read_excel("data/state_election_results/delaware_president.xlsx") %>%
  mutate(state = "Delaware") %>%
  mutate(dispID = paste(county, state, sep = ", "))
florida_president <- read_excel("data/state_election_results/florida_president.xlsx") %>%
  mutate(state = "Florida") %>%
  mutate(dispID = paste(county, state, sep = ", "))
georgia_president <- read_excel("data/state_election_results/georgia-president.xlsx") %>%
  mutate(state = "Georgia") %>%
  mutate(dispID = paste(county, state, sep = ", "))
hawaii_president <- read_excel("data/state_election_results/hawaii_president.xlsx") %>%
  mutate(state = "Hawaii") %>%
  mutate(dispID = paste(county, state, sep = ", "))
idaho_president <- read_excel("data/state_election_results/idaho_president.xlsx") %>%
  mutate(state = "Idaho") %>%
  mutate(dispID = paste(county, state, sep = ", "))
illinois_president <- read_excel("data/state_election_results/illinois_president.xlsx") %>%
  mutate(state = "Illinois") %>%
  mutate(dispID = paste(county, state, sep = ", "))
indiana_president <- read_excel("data/state_election_results/indiana_president.xlsx") %>%
  mutate(state = "Indiana") %>%
  mutate(dispID = paste(county, state, sep = ", "))
iowa_president <- read_excel("data/state_election_results/iowa_president.xlsx") %>%
  mutate(state = "Iowa") %>%
  mutate(dispID = paste(county, state, sep = ", "))
kansas_president <- read_excel("data/state_election_results/kansas_president.xlsx") %>%
  mutate(state = "Kansas") %>%
  mutate(dispID = paste(county, state, sep = ", "))
kentucky_president <- read_excel("data/state_election_results/kentucky_president.xlsx") %>%
  mutate(state = "Kentucky") %>%
  mutate(dispID = paste(county, state, sep = ", "))
louisiana_president <- read_excel("data/state_election_results/louisiana_president.xlsx") %>%
  mutate(state = "Louisiana") %>%
  mutate(dispID = paste(county, state, sep = ", "))
maine_president <- read_excel("data/state_election_results/maine_president.xlsx") %>%
  mutate(state = "Maine") %>%
  mutate(dispID = paste(county, state, sep = ", "))
maryland_president <- read_excel("data/state_election_results/maryland_president.xlsx") %>%
  mutate(state = "Maryland") %>%
  mutate(dispID = paste(county, state, sep = ", "))
massachusetts_president <- read_excel("data/state_election_results/Massachusetts_president.xlsx") %>%
  mutate(state = "Massachusetts") %>%
  mutate(dispID = paste(county, state, sep = ", "))
michigan_president <- read_excel("data/state_election_results/michigan_president.xlsx") %>%
  mutate(state = "Michigan") %>%
  mutate(dispID = paste(county, state, sep = ", "))
minnesota_president <- read_excel("data/state_election_results/minnesota_president.xlsx") %>%
  mutate(state = "Minnesota") %>%
  mutate(dispID = paste(county, state, sep = ", "))
mississippi_president <- read_excel("data/state_election_results/mississippi_president.xlsx") %>%
  mutate(state = "Mississippi") %>%
  mutate(dispID = paste(county, state, sep = ", "))
missouri_president <- read_excel("data/state_election_results/missouri_president.xlsx") %>%
  mutate(state = "Missouri") %>%
  mutate(dispID = paste(county, state, sep = ", "))
montana_president <- read_excel("data/state_election_results/montana_president.xlsx") %>%
  mutate(state = "Montana") %>%
  mutate(dispID = paste(county, state, sep = ", "))
nebraska_president <- read_excel("data/state_election_results/nebraska_president.xlsx") %>%
  mutate(state = "Nebraska") %>%
  mutate(dispID = paste(county, state, sep = ", "))
nevada_president <- read_excel("data/state_election_results/nevada_president.xlsx") %>%
  mutate(state = "Nevada") %>%
  mutate(dispID = paste(county, state, sep = ", "))
newhampshire_president <- read_excel("data/state_election_results/newhampshire_president.xlsx") %>%
  mutate(state = "New Hampshire") %>%
  mutate(dispID = paste(county, state, sep = ", "))
newjersey_president <- read_excel("data/state_election_results/newjersey_president.xlsx") %>%
  mutate(state = "New Jersey") %>%
  mutate(dispID = paste(county, state, sep = ", "))
newmexico_president <- read_excel("data/state_election_results/newmexico_president.xlsx") %>%
  mutate(state = "New Mexico") %>%
  mutate(dispID = paste(county, state, sep = ", "))
newyork_president <- read_excel("data/state_election_results/newyork_president.xlsx") %>%
  mutate(state = "New York") %>%
  mutate(dispID = paste(county, state, sep = ", "))
northcarolina_president <- read_excel("data/state_election_results/northcarolina_president.xlsx") %>%
  mutate(state = "North Carolina") %>%
  mutate(dispID = paste(county, state, sep = ", "))
northdakota_president <- read_excel("data/state_election_results/northdakota_president.xlsx") %>%
  mutate(state = "North Dakota") %>%
  mutate(dispID = paste(county, state, sep = ", "))
ohio_president <- read_excel("data/state_election_results/ohio_president.xlsx") %>%
  mutate(state = "Ohio") %>%
  mutate(dispID = paste(county, state, sep = ", "))
oklahoma_president <- read_excel("data/state_election_results/oklahoma_president.xlsx") %>%
  mutate(state = "Oklahoma") %>%
  mutate(dispID = paste(county, state, sep = ", "))
oregon_president <- read_excel("data/state_election_results/oregon_president.xlsx") %>%
  mutate(state = "Oregon") %>%
  mutate(dispID = paste(county, state, sep = ", "))
pennsylvania_president <- read_excel("data/state_election_results/pennsylvania_president.xlsx") %>%
  mutate(state = "Pennsylvania") %>%
  mutate(dispID = paste(county, state, sep = ", "))
rhodeisland_president <- read_excel("data/state_election_results/rhodeisland_president.xlsx") %>%
  mutate(state = "Rhode Island") %>%
  mutate(dispID = paste(county, state, sep = ", "))
southcarolina_president <- read_excel("data/state_election_results/southcarolina_president.xlsx") %>%
  mutate(state = "South Carolina") %>%
  mutate(dispID = paste(county, state, sep = ", "))
southdakota_president <- read_excel("data/state_election_results/southdakota_president.xlsx") %>%
  mutate(state = "South Dakota") %>%
  mutate(dispID = paste(county, state, sep = ", "))
tennessee_president <- read_excel("data/state_election_results/tennessee_president.xlsx") %>%
  mutate(state = "Tennessee") %>%
  mutate(dispID = paste(county, state, sep = ", "))
texas_president <- read_excel("data/state_election_results/texas_president.xlsx") %>%
  mutate(state = "Texas") %>%
  mutate(dispID = paste(county, state, sep = ", "))
utah_president <- read_excel("data/state_election_results/utah_president.xlsx") %>%
  mutate(state = "Utah") %>%
  mutate(dispID = paste(county, state, sep = ", "))
vermont_president <- read_excel("data/state_election_results/vermont_president.xlsx") %>%
  mutate(state = "Vermont") %>%
  mutate(dispID = paste(county, state, sep = ", "))
virginia_president <- read_excel("data/state_election_results/virginia_president.xlsx") %>%
  mutate(state = "Virginia") %>%
  mutate(dispID = paste(county, state, sep = ", "))
washington_president <- read_excel("data/state_election_results/washington_president.xlsx") %>%
  mutate(state = "Washington") %>%
  mutate(dispID = paste(county, state, sep = ", "))
westvirginia_president <- read_excel("data/state_election_results/westvirginia_president.xlsx") %>%
  mutate(state = "West Virginia") %>%
  mutate(dispID = paste(county, state, sep = ", "))
wisconsin_president <- read_excel("data/state_election_results/wisconsin_president.xlsx") %>%
  mutate(state = "Wisconsin") %>%
  mutate(dispID = paste(county, state, sep = ", "))
wyoming_president <- read_excel("data/state_election_results/wyoming_president.xlsx") %>%
  mutate(state = "Wyoming") %>%
  mutate(dispID = paste(county, state, sep = ", "))

president_list <- list(
  alabama_president,
  arkansas_president,
  arizona_president,
  california_president,
  colorado_president,
  connecticut_president,
  delaware_president,
  florida_president,
  georgia_president,
  hawaii_president,
  idaho_president,
  illinois_president,
  indiana_president,
  iowa_president,
  kansas_president,
  kentucky_president,
  louisiana_president,
  maine_president,
  maryland_president,
  massachusetts_president,
  michigan_president,
  minnesota_president,
  mississippi_president,
  missouri_president,
  montana_president,
  nebraska_president,
  nevada_president,
  newhampshire_president,
  newjersey_president,
  newmexico_president,
  newyork_president,
  northcarolina_president,
  northdakota_president,
  ohio_president,
  oklahoma_president,
  oregon_president,
  pennsylvania_president,
  rhodeisland_president,
  southcarolina_president,
  southdakota_president,
  tennessee_president,
  texas_president,
  utah_president,
  vermont_president,
  virginia_president,
  washington_president,
  westvirginia_president,
  wisconsin_president,
  wyoming_president
)

president_join <- president_list %>% reduce(full_join)

covid_county <- read_excel("data/rt_table_export.xlsx") %>%
  filter(resolution == "county") %>%
  arrange(date) 

print(president_join[1:10, 1:7])
```


\newpage

## Interactions

I decided to look at the relationship between the Percentage of Trump votes in a county or the Percentage of Biden votes in a county to the R at five different dates: Nov 4, Oct 28, Oct 21, Oct 14, and Oct 7. I chose dates that were multiples of one week prior to election day, as well as election day itself. So, I created five new dataframes created by merging the election results with the covid data on those four days.

```{r}
cc_nov_4 <- covid_county %>%
  merge(president_join, covid_county, by.x = "dispID", by.y = "dispID") %>%
  mutate(date = as.character(date)) %>%
  filter(date == "2020-11-04") %>%
  mutate(county_name = paste(county, "County")) %>%
  mutate(avg = mean(Rt_plot)) %>%
  mutate(Rt_04 = Rt_plot)

cc_oct_28 <-  covid_county %>%
  merge(president_join, covid_county, by.x = "dispID", by.y = "dispID") %>%
  mutate(date = as.character(date)) %>%
  filter(date == "2020-10-28") %>%
  mutate(county_name = paste(county, "County")) %>%
  mutate(avg = mean(Rt_plot)) %>%
  mutate(Rt_28 = Rt_plot)

cc_oct_21 <-  covid_county %>%
  merge(president_join, covid_county, by.x = "dispID", by.y = "dispID") %>%
  mutate(date = as.character(date)) %>%
  filter(date == "2020-10-21") %>%
  mutate(county_name = paste(county, "County")) %>%
  mutate(Rt_21 = Rt_plot)

cc_oct_14 <-  covid_county %>%
  merge(president_join, covid_county, by.x = "dispID", by.y = "dispID") %>%
  mutate(date = as.character(date)) %>%
  filter(date == "2020-10-14") %>%
  mutate(county_name = paste(county, "County")) %>%
  mutate(Rt_14 = Rt_plot)

cc_oct_7 <-  covid_county %>%
  merge(president_join, covid_county, by.x = "dispID", by.y = "dispID") %>%
  mutate(date = as.character(date)) %>%
  filter(date == "2020-10-07") %>%
  mutate(county_name = paste(county, "County")) %>%
  mutate(Rt_7 = Rt_plot)
```

To assist with understanding the national distribution of *R* on those five days, I have created a sample density plot for November 4 shown below. The median *R* is above zero.

```{r, message=FALSE}
ggplot(data = cc_nov_4, aes(x = Rt_plot)) +
  geom_density() +
  labs(title = "Distribution of R Numbers of US Counties",
       x = "R",
       y = "Density (arbitrary scale)") +
  theme_minimal() +
  coord_cartesian(xlim = c(.4, 3))
  # 
  # p2 <- ggplot(data = cc_oct_28, aes(x = Rt_plot)) +
  #   geom_density() +
  #   labs(title = "October 28",
  #        x = "R",
  #        y = "Density (arbitrary scale)") +
  #   theme_minimal() +
  #   coord_cartesian(xlim = c(.4, 3))
  # 
  # p3 <- ggplot(data = cc_oct_21, aes(x = Rt_plot)) +
  #   geom_density() +
  #   labs(title = "October 21",
  #        x = "R",
  #        y = "Density (arbitrary scale)") +
  #   theme_minimal() +
  #   coord_cartesian(xlim = c(.4, 3))
  # 
  # p4 <- ggplot(data = cc_oct_14, aes(x = Rt_plot)) +
  #   geom_density() +
  #   labs(title = "October 14",
  #        x = "R",
  #        y = "Density (arbitrary scale)") +
  #   theme_minimal() +
  #   coord_cartesian(xlim = c(.4, 3))
  # 
  # p5 <- ggplot(data = cc_oct_7, aes(x = Rt_plot), size = 3) +
  #   geom_density() +
  #   labs(title = "October 7",
  #        x = "R",
  #        y = "Density (arbitrary scale)") +
  #   theme_minimal() +
  #   coord_cartesian(xlim = c(.4, 3))
  # 
  # figure <-  ggarrange(p1, p2, p3, p4, p5,
  #                      ncol = 3, nrow = 2)
  # figure
  # 

```

\newpage

## Differences in Means for Percentage of Trump Votes on *R* for Nov 4, Oct 28, Oct 21, Oct 14, and Oct 7

```{r, message=FALSE, echo=FALSE}
Rt_diff_trump_4 <- lm(cc_nov_4$trump.percent ~ cc_nov_4$Rt_plot, data = cc_nov_4)
Rt_diff_trump_28 <- lm(cc_oct_28$trump.percent ~ cc_oct_28$Rt_plot, data = cc_oct_28)
Rt_diff_trump_21 <-  lm(cc_oct_21$biden.percent ~ cc_oct_21$Rt_plot, data = cc_oct_21)
Rt_diff_trump_14 <-  lm(cc_oct_14$trump.percent ~ cc_oct_14$Rt_plot, data = cc_oct_14)
Rt_diff_trump_7 <- lm(cc_oct_7$trump.percent ~ cc_oct_7$Rt_plot, data = cc_oct_7)

Rt_diff_trump_list <-  list(Rt_diff_trump_4, Rt_diff_trump_28, Rt_diff_trump_21, Rt_diff_trump_14, Rt_diff_trump_7)
names(Rt_diff_trump_list) <- c("Nov 4", "Oct 28", "Oct 21", "Oct 14", "Oct 7")

modelsummary::modelsummary(models = Rt_diff_trump_list, 
                           stars = TRUE, 
                           title = "Regression Table between Percentage of Trump Votes and R per County")
```

When percentage of Trump votes per county (trump.percent) was predicted it was found that Rt_plot on election day (Nov 4) was a significant  predictor (t = 2.892, p = 0.00388). The overall model fit is R^2 = 0.0062. The difference in means is 0.022859.

Because the p-value is lower than the standard threshold of alpha = .05 we can reject the null hypothesis that the relationship of trump.percent to Rt_plot on Election Day is zero. This does not necessarily imply a causal relationship, however. It could be that in a county with high proportions of Trump support people are less likely to take Covid-19 seriously, or it could be that living in counties with high Rt_plot would make people more likely to vote for Trump (vote for the chaotic candidate in a chaotic circumstance).
\newpage

## Differences in Means for Percentage of Biden Votes on R for Nov 4, Oct 28, Oct 21, Oct 14, and Oct 7

```{r, message=FALSE}
Rt_diff_biden_4 <- lm(cc_nov_4$biden.percent ~ cc_nov_4$Rt_plot, data = cc_nov_4)
Rt_diff_biden_28 <- lm(cc_oct_28$biden.percent ~ cc_oct_28$Rt_plot, data = cc_oct_28)
Rt_diff_biden_21 <-  lm(cc_oct_21$biden.percent ~ cc_oct_21$Rt_plot, data = cc_oct_21)
Rt_diff_biden_14 <-  lm(cc_oct_14$biden.percent ~ cc_oct_14$Rt_plot, data = cc_oct_14)
Rt_diff_biden_7 <- lm(cc_oct_7$biden.percent ~ cc_oct_7$Rt_plot, data = cc_oct_7)

Rt_diff_biden_list <-  list(Rt_diff_biden_4, Rt_diff_biden_28, Rt_diff_biden_21, Rt_diff_biden_14, Rt_diff_biden_7)
names(Rt_diff_biden_list) <- c("Nov 4", "Oct 28", "Oct 21", "Oct 14", "Oct 7")

modelsummary::modelsummary(models = Rt_diff_biden_list, 
                           stars = TRUE, 
                           title = "Regression Table between Percentage of Biden Votes and R")
```

When percentage of Biden votes per county (biden.percent) was predicted it was found that Rt_plot on election day (Nov 4) was a significant negative/inverse predictor (t = -2.621, p = 0.00887). The overall model fit is R^2 = 0.005097, and the difference in means is -0.020582.

Because the p-value is smaller than the standard threshold of alpha = .05 we can reject the null hypothesis that the relationship of biden.percent to Rt_plot on Election Day is zero. In comparison to the relationship between trump.percent and Rt_plot, biden.percent is less strongly related to Rt_plot.








\newpage

## R on a County Level

To achieve a more granular perspective on R on November 4 (Election Day), a map is shown below, where darker shades indicate higher R. Some counties are missing due to the incompleteness of the dataset. OWID did not calculate R in counties that did not have a sufficiently high case count. 

```{r, echo = FALSE, message=FALSE}
cc_nov_4 <- covid_county %>%
  merge(president_join, covid_county, by.x = "dispID", by.y = "dispID") %>%
  mutate(date = as.character(date)) %>%
  filter(date == "2020-11-04") %>%
  mutate(county_name = paste(county, "County")) %>%
  mutate(avg = mean(Rt_plot)) %>%
  mutate(Rt_4 = Rt_plot)

cc_nov_4 <- countydata %>%
ggplot(aes(long, lat, group = group, fill = Rt_plot)) +
  geom_polygon(color = "#ffffff", size = 0.05) +
  theme_bw() +
  coord_map(projection = "albers", lat0 = 39, lat1 = 45) +
  labs(title = "Reproduction Number on Election Day (Nov 4)", 
       y = "Latitude",
       x = "Longitude") 
```




## Sources and References
https://royalsociety.org/news/2020/09/set-c-covid-r-rate/

Chongsuvivatwong, Virasakdi. Analysis of epidemiological data using R and Epicalc. 2008, Hat Yai, Thailand: Chammuang Press.

Boelle, Pierre-Yves, Thomas Obadia. "Estimation of R0 and Real-Time Reproduction Number from Epidemics." 

https://ourworldindata.org/coronavirus

https://github.com/lin-lab/COVID19-Viz/tree/master/clean_data

County data was manually scraped from nbcnews.com and politico.com on 2020-11-19, 2020-11-20, and 2020-12-11. Alaska was excluded due to discrepancies in the formatting of the data.

Dong, E., Du, H., & Gardner, L. (2020). An interactive web-based dashboard to track COVID-19 in real time. The Lancet infectious diseases, 20(5), 533-534.

For reproduction rate by county, the dataset was too large for github so I manually reduced the size to exclude data from before November 15 and to exclude counties/dates that had too small of a sample size to produce a reproduction rate, as determined by the study. 


